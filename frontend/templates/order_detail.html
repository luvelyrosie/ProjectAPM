{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-primary mb-3">Детали заказа (ID: {{ order.id }})</h2>
    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-borderless mb-3">
                <tbody>
                    <tr>
                        <th>ID заказа</th>
                        <td>{{ order.id }}</td>
                    </tr>
                    <tr>
                        <th>Статус</th>
                        <td>
                            <span class="badge 
                                {% if order.status == 'Готово к работе' %}bg-primary
                                {% elif order.status == 'В работе' %}bg-warning
                                {% elif order.status == 'Готово' %}bg-success
                                {% elif order.status == 'Брак' %}bg-danger
                                {% else %}bg-secondary{% endif %}">
                                {{ order.status or "N/A" }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>Создан</th>
                        <td>{{ order.created_at.strftime('%d-%m-%Y %H:%M') if order.created_at else "Н/Д" }}</td>
                    </tr>
                    <tr>
                        <th>Обновлён</th>
                        <td>{{ order.updated_at.strftime('%d-%m-%Y %H:%M') if order.updated_at else "Н/Д" }}</td>
                    </tr>
                    <tr>
                        <th>Назначенный оператор</th>
                        <td>{{ order.operator.username if order.operator else "Не назначено" }}</td>
                    </tr>
                </tbody>
            </table>

            <h5 class="mt-4">Задачи</h5>
            {% if order.tasks %}
            <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Название</th>
                            <th>Статус</th>
                            <th>Время начала</th>
                            <th>Время окончания</th>
                            <th>Действия</th>

                        </tr>
                    </thead>
                    <tbody>
                        {% for task in order.tasks %}
                        <tr>
                            <td>{{ task.id }}</td>
                            <td>{{ task.name or "N/A" }}</td>
                            <td>
                                <span class="badge 
                                    {% if task.status == 'Готово' %}bg-success
                                    {% elif task.status == 'Брак' %}bg-danger
                                    {% elif task.status == 'В работе' %}bg-warning
                                    {% elif task.status == 'Готово к работе' %}bg-primary
                                    {% else %}bg-secondary{% endif %}">
                                    {{ task.status }}
                                </span>
                            </td>
                            <td>{{ task.start_time.strftime('%d-%m-%Y %H:%M:%S') if task.start_time else "N/A" }}</td>
                            <td>{{ task.end_time.strftime('%d-%m-%Y %H:%M:%S') if task.end_time else "N/A" }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {% set status = task.status.strip() if task.status else '' %}

                                    {% if task.status == 'Готово к работе' %}
                                    <button onclick="takeTask({{ task.id }})" class="btn btn-success">Начинать</button>
                                    {% endif %}
                                    {% if task.status == 'В работе' %}
                                    <button onclick="completeTask({{ task.id }})" class="btn btn-primary">Готово</button>
                                    {% endif %}
                                    {% if task.status not in ['Готово', 'Брак'] %}
                                    <button onclick="rejectTask({{ task.id }})" class="btn btn-danger">Брак</button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% else %}
                <p class="text-muted">Для этого заказа задачи не назначены.</p>
            {% endif %}

            <a href="/admin/tasks/create-task/page/{{ order.id }}" class="btn btn-success mt-3">Создать задачу</a>
            <a href="/orders/page" class="btn btn-primary mt-3">Назад к заказам</a>


        </div>
    </div>
</div>
{% endblock %}